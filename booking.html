<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KTM Booking</title>
  <script>
    if (!localStorage.getItem("ktmLoggedIn")) {
      alert("Please login first.");
      window.location.href = "index.html";
    }
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>KTM Malaysia</h1>
    <button class="menu-toggle" onclick="toggleMenu()">☰</button>
    <nav id="mainNav">
      <a href="index.html">Home</a>
      <a href="schedule.html">Schedule</a>
      <a href="booking.html" class="active">Booking</a>
      <a href="userprofile.html">Profile</a>
      <a href="#" onclick="logout()" style="color:red;">Logout</a>
    </nav>
    <select class="language-select" onchange="setLanguage(this.value)">
      <option value="en">English</option>
      <option value="ms">Malay</option>
      <option value="zh">中文</option>
    </select>
  </header>

  <main>
    <div class="profile-section">
      <h2 data-en="Booking Details" data-ms="Butiran Tempahan" data-zh="预订详情">Booking Details</h2>
      <div id="bookingForm">

    <label data-en="Ticket Type" data-ms="Jenis Tiket" data-zh="车票类型">Ticket Type</label>
    <div style="margin-top: 10px;">
      <label><input type="radio" name="ticketType" value="oneway" checked> <span data-en="One-way" data-ms="Sehala" data-zh="单程">One-way</span></label>
      <label style="margin-left: 20px;"><input type="radio" name="ticketType" value="roundtrip"> <span data-en="Round-trip" data-ms="Pergi-balik" data-zh="往返">Round-trip</span></label>
    </div>

    <label data-en="Passenger Type" data-ms="Jenis Penumpang" data-zh="乘客类型">Passenger Type</label>
    <div style="margin-top: 10px;">
      <label><input type="radio" name="passengerType" value="adult" checked> <span data-en="Adult" data-ms="Dewasa" data-zh="成人">Adult</span></label>
      <label style="margin-left: 20px;"><input type="radio" name="passengerType" value="child"> <span data-en="Child" data-ms="Kanak-kanak" data-zh="儿童">Child</span></label>
      <label style="margin-left: 20px;"><input type="radio" name="passengerType" value="oku"> <span data-en="OKU" data-ms="OKU" data-zh="残障人士">OKU</span></label>
    </div>

    <label for="departure" data-en="Departure Station" data-ms="Stesen Bertolak" data-zh="出发站">Departure Station</label>
    <select id="departure" onchange="updateDestinations()">
      <option value="" data-en="-- Select --" data-ms="-- Pilih --" data-zh="-- 选择 --">-- Select --</option>
    </select>

    <label for="destination" data-en="Destination Station" data-ms="Stesen Destinasi" data-zh="目的地站">Destination Station</label>
    <select id="destination" onchange="updateTimes()">
      <option value="" data-en="-- Select --" data-ms="-- Pilih --" data-zh="-- 选择 --">-- Select --</option>
    </select>

    <label for="date" data-en="Travel Date" data-ms="Tarikh Perjalanan" data-zh="出发日期">Travel Date</label>
    <input type="date" id="date">

    <div class="schedule-options" id="schedule-options"></div>

    <div id="passenger-section" style="display:none;">
      <label for="passengers" data-en="Number of Passengers" data-ms="Bilangan Penumpang" data-zh="乘客人数">Number of Passengers</label>
      <input type="number" id="passengers" min="1" max="10">
      <button class="btn" onclick="confirmBooking()" data-en="Confirm Booking" data-ms="Sahkan Tempahan" data-zh="确认预订">Confirm Booking</button>
    </div>

    <div id="success-message"></div>
  </main>

  <footer>
    &copy; 2025 KTM Malaysia. All rights reserved.
  </footer>

  <script>
    const routes = {
      "KL Sentral": ["Kajang", "UKM", "Seremban", "Pulau Sebang"],
      "Kajang": ["Seremban", "Pulau Sebang"],
      "UKM": ["Seremban"],
      "Seremban": ["Pulau Sebang"]
    };

    const trainTimes = {
      "KL Sentral-Kajang": ["06:33"],
      "KL Sentral-UKM": ["07:00"],
      "KL Sentral-Seremban": ["07:45"],
      "KL Sentral-Pulau Sebang": ["09:03", "17:00", "21:30"],
      "Kajang-Seremban": ["10:30"],
      "Kajang-Pulau Sebang": ["13:15"],
      "UKM-Seremban": ["13:28"],
      "Seremban-Pulau Sebang": ["14:51"]
    };

    const ticketPrices = {
      "KL Sentral-Kajang": 6,
      "KL Sentral-UKM": 8,
      "KL Sentral-Seremban": 12,
      "KL Sentral-Pulau Sebang": 16,
      "Kajang-Seremban": 8,
      "Kajang-Pulau Sebang": 12,
      "UKM-Seremban": 6,
      "Seremban-Pulau Sebang": 6
    };

    const discounts = {
      "adult": 1.0,
      "child": 0.5,
      "oku": 0.7
    };

    let selectedTime = "";

    window.onload = () => {
      const depSelect = document.getElementById("departure");
      Object.keys(routes).forEach(station => {
        const opt = document.createElement("option");
        opt.value = station;
        opt.textContent = station;
        opt.setAttribute('data-en', station);
        opt.setAttribute('data-ms', station);
        opt.setAttribute('data-zh', station);
        depSelect.appendChild(opt);
      });
      // Apply current language
      const currentLang = document.querySelector('.language-select').value;
      setLanguage(currentLang);
    };

    function updateDestinations() {
      const dep = document.getElementById("departure").value;
      const destSelect = document.getElementById("destination");
      const currentLang = document.querySelector('.language-select').value;
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.setAttribute('data-en', '-- Select --');
      defaultOption.setAttribute('data-ms', '-- Pilih --');
      defaultOption.setAttribute('data-zh', '-- 选择 --');
      defaultOption.text = defaultOption.getAttribute(`data-${currentLang}`);
      destSelect.innerHTML = '';
      destSelect.appendChild(defaultOption);
      if (routes[dep]) {
        routes[dep].forEach(dest => {
          const opt = document.createElement("option");
          opt.value = dest;
          opt.textContent = dest;
          opt.setAttribute('data-en', dest);
          opt.setAttribute('data-ms', dest);
          opt.setAttribute('data-zh', dest);
          destSelect.appendChild(opt);
        });
        setLanguage(currentLang);
      }
      document.getElementById("schedule-options").innerHTML = "";
      document.getElementById("passenger-section").style.display = "none";
    }

    function updateTimes() {
      const from = document.getElementById("departure").value;
      const to = document.getElementById("destination").value;
      const key = `${from}-${to}`;
      const optionsDiv = document.getElementById("schedule-options");
      optionsDiv.innerHTML = "";

      if (trainTimes[key]) {
        optionsDiv.innerHTML = `<p><strong data-en="Available Trains:" data-ms="Kereta Api yang Tersedia:" data-zh="可选列车：">Available Trains:</strong></p>`;
        trainTimes[key].forEach(time => {
          const div = document.createElement("div");
          div.textContent = time;
          div.onclick = () => {
            selectedTime = time;
            document.getElementById("passenger-section").style.display = "block";
          };
          optionsDiv.appendChild(div);
        });
      } else {
        optionsDiv.innerHTML = `<p><em data-en="No trains found for this route." data-ms="Tiada kereta api untuk laluan ini." data-zh="此路线暂无列车。">No trains found for this route.</em></p>`;
        document.getElementById("passenger-section").style.display = "none";
      }
      document.getElementById("success-message").style.display = "none";
    }

    function confirmBooking() {
      const from = document.getElementById("departure").value;
      const to = document.getElementById("destination").value;
      const date = document.getElementById("date").value;
      const pax = parseInt(document.getElementById("passengers").value);
      const type = document.querySelector('input[name="ticketType"]:checked').value;
      const passengerType = document.querySelector('input[name="passengerType"]:checked').value;

      if (!from || !to || !date || !selectedTime || !pax) {
        const lang = document.querySelector('.language-select').value;
        const messages = {
          'en': 'Please complete all fields.',
          'ms': 'Sila lengkapkan semua medan.',
          'zh': '请填写所有字段。'
        };
        alert(messages[lang]);
        return;
      }

      // Calculate total price
      const routeKey = `${from}-${to}`;
      const basePrice = ticketPrices[routeKey];
      const discount = discounts[passengerType];
      const total = basePrice * pax * discount * (type === 'roundtrip' ? 2 : 1);

      // Save booking details for receipt
      const bookingDetails = {
        from,
        to,
        date,
        time: selectedTime,
        passengers: pax,
        total: total.toFixed(2),
        type,
        passengerType
      };
      localStorage.setItem('currentBooking', JSON.stringify(bookingDetails));

      // Redirect to receipt page
      window.location.href = 'receipt.html';
        return;
      }

      const routeKey = `${from}-${to}`;
      const unitPrice = ticketPrices[routeKey] || 10;
      const isRoundTrip = type === "roundtrip";
      const passengerType = document.querySelector('input[name="passengerType"]:checked').value;
      const discount = discounts[passengerType];
      const totalPrice = unitPrice * pax * (isRoundTrip ? 2 : 1) * discount;

      const msg = `
        ✅ Booking successful!<br>
        <span data-en="You have booked a" data-ms="Anda telah menempah" data-zh="您已预订"></span> <strong>${type === "roundtrip" ? "<span data-en='Round-trip' data-ms='Pergi-balik' data-zh='往返'>Round-trip</span>" : "<span data-en='One-way' data-ms='Sehala' data-zh='单程'>One-way</span>"}</strong> <span data-en="ticket" data-ms="tiket" data-zh="车票"></span>
        <span data-en="from" data-ms="dari" data-zh="从"></span> <strong>${from}</strong> <span data-en="to" data-ms="ke" data-zh="到"></span> <strong>${to}</strong>
        <span data-en="on" data-ms="pada" data-zh="于"></span> <strong>${date}</strong> <span data-en="at" data-ms="pada jam" data-zh="在"></span> <strong>${selectedTime}</strong>
        <span data-en="for" data-ms="untuk" data-zh="为"></span> <strong>${pax}</strong> <span data-en="passenger(s)" data-ms="penumpang" data-zh="位乘客"></span>.<br><br>
        <strong><span data-en="Total Price" data-ms="Jumlah Harga" data-zh="总价"></span>:</strong> RM ${totalPrice.toFixed(2)}
      `;

      const successBox = document.getElementById("success-message");
      successBox.innerHTML = msg;
      successBox.style.display = "block";
    

    function setLanguage(lang) {
      document.querySelectorAll('[data-en]').forEach(el => {
        if (el.tagName === 'OPTION') {
          el.text = el.getAttribute(`data-${lang}`);
        } else {
          el.innerHTML = el.getAttribute(`data-${lang}`);
        }
      });
      // Update dynamic select options
      updateDestinations();
      updateTimes();
    }

    function logout() {
      localStorage.removeItem("ktmLoggedIn");
      window.location.href = "index.html";
    }

    function toggleMenu() {
      const nav = document.getElementById("mainNav");
      nav.classList.toggle("show");
    }
  </script>
</body>
</html>
